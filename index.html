<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lichternacht Bechhofen 2025</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fbbf24">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lichternacht">

    <!-- Icons & Manifest -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- ==========================================
       CSS STYLES
       ========================================== -->
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Cinzel', serif;
        }

        /* Full height map fix */
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        /* UI Elements */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            border-top: 1px solid #e5e7eb;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-active {
            color: #d97706;
        }

        .tab-inactive {
            color: #9ca3af;
        }

        .scroll-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding-bottom: 80px;
        }

        /* Map cleanups */
        .leaflet-routing-container {
            display: none !important;
        }

        /* Admin specific */
        .admin-mode .editable {
            border: 2px dashed #f59e0b;
            cursor: move;
        }

        .admin-badge {
            display: none;
        }

        .admin-mode .admin-badge {
            display: inline-flex;
        }

        /* Tags */
        .tag-badge {
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-badge.selected {
            background-color: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: white;
            color: #333;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid #fbbf24;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        /* Loading Spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #d97706;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #loading-overlay {
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body class="overflow-hidden bg-gray-100 text-gray-900">

    <!-- App Container -->
    <!-- App Container -->
    <div id="app" class="h-[100dvh] flex flex-col relative">

        <!-- Loading Overlay -->
        <div id="loading-overlay"
            class="hidden absolute inset-0 z-[9999] bg-white/50 flex items-center justify-center flex-col">
            <div class="spinner mb-2"></div>
            <span class="text-xs font-bold text-yellow-700" id="loading-text">Lade...</span>
        </div>

        <!-- Toast Container for Notifications -->
        <div id="toast-container"></div>

        <!-- Header -->
        <header
            class="bg-white/90 backdrop-blur-md p-4 border-b border-yellow-600/30 flex justify-between items-center z-50 shadow-sm flex-shrink-0">
            <div>
                <h1 class="text-xl font-bold text-yellow-700 tracking-wider brand-font">LICHTERNACHT</h1>
                <p class="text-xs text-yellow-800/70">Bechhofen | 22. Nov 2025</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleAdminLogin()" class="text-gray-400 hover:text-yellow-600 transition-colors">
                    <i class="ph ph-lock-key text-xl" id="lock-icon"></i>
                </button>
                <div id="status-indicator"
                    class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500 border border-gray-200 font-medium">
                    Starten...
                </div>
            </div>
        </header>

        <!-- Admin Bar (Logged in) -->
        <div id="admin-bar"
            class="hidden bg-yellow-500 text-black px-4 py-2 text-xs font-bold flex justify-between items-center z-50 shadow-md">
            <span>üîß ADMIN (Lokal)</span>
            <div class="flex gap-2">
                <button onclick="handleAdminAdd()" class="bg-black text-white px-2 py-1 rounded hover:bg-gray-800"><i
                        class="ph ph-plus"></i> Neu</button>
                <button onclick="toggleAdminPanel()" class="bg-black text-white px-2 py-1 rounded hover:bg-gray-800"><i
                        class="ph ph-export"></i> Export</button>
                <button onclick="logoutAdmin()" class="bg-black/20 px-2 py-1 rounded hover:bg-black/40">Exit</button>
            </div>
        </div>

        <!-- Main Content Views -->
        <main class="flex-grow relative bg-gray-50 overflow-hidden">

            <!-- VIEW: KARTE -->
            <div id="view-map" class="view-section h-full w-full relative">
                <div id="map" class="h-full w-full bg-gray-200"></div>

                <!-- Admin Export Panel -->
                <div id="admin-panel"
                    class="hidden admin-panel absolute top-10 left-5 right-5 bg-white p-5 rounded-lg shadow-xl z-[5000]">
                    <h3 class="font-bold text-lg mb-2">Daten Exportieren</h3>
                    <p class="text-sm text-gray-600 mb-2">Daten sichern:</p>
                    <textarea id="export-area" class="w-full h-48 p-2 border rounded text-xs font-mono bg-gray-50"
                        readonly></textarea>
                    <div class="flex justify-end gap-2 mt-4">
                        <button
                            onclick="document.getElementById('export-area').select(); document.execCommand('copy'); showToast('In Zwischenablage kopiert', 'success');"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Kopieren</button>
                        <button onclick="toggleAdminPanel()"
                            class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Schlie√üen</button>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="absolute top-4 right-4 z-[400] flex flex-col gap-2">
                    <button onclick="locateUser()"
                        class="bg-white text-yellow-600 p-3 rounded-full shadow-lg border border-gray-200 active:bg-gray-50 transition-colors">
                        <i class="ph ph-crosshair text-xl"></i>
                    </button>
                    <button onclick="resetMap()"
                        class="bg-white text-gray-700 p-3 rounded-full shadow-lg border border-gray-200 active:bg-gray-50 transition-colors">
                        <i class="ph ph-house text-xl"></i>
                    </button>
                </div>

                <!-- Routing Info -->
                <div id="route-info"
                    class="hidden absolute top-4 left-4 right-16 z-[400] bg-white/90 backdrop-blur p-3 rounded-lg shadow-lg border border-yellow-500/30 flex justify-between items-center">
                    <div>
                        <span class="text-xs font-bold text-yellow-600 uppercase">Route aktiv</span>
                        <div class="text-sm font-bold">Ziel wird angezeigt</div>
                    </div>
                    <button onclick="clearRoute()"
                        class="bg-gray-200 hover:bg-gray-300 rounded-full p-2 text-gray-600"><i
                            class="ph ph-x"></i></button>
                </div>
            </div>

            <!-- VIEW: LISTE -->
            <div id="view-list" class="view-section h-full w-full hidden flex flex-col">
                <div class="p-4 bg-gray-50 sticky top-0 z-10 border-b border-gray-200 shadow-sm flex-shrink-0">
                    <div class="relative mb-3">
                        <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="search-input" placeholder="Suche..."
                            class="w-full bg-white text-gray-800 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500 border border-gray-300 shadow-sm">
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="filterList('all')"
                            class="filter-btn active px-4 py-1 rounded-full text-sm bg-yellow-600 text-white font-medium whitespace-nowrap shadow-sm">Alle</button>
                        <button onclick="filterList('food')"
                            class="filter-btn px-4 py-1 rounded-full text-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 whitespace-nowrap">Essen</button>
                        <button onclick="filterList('drink')"
                            class="filter-btn px-4 py-1 rounded-full text-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 whitespace-nowrap">Getr√§nke</button>
                        <button onclick="filterList('kids')"
                            class="filter-btn px-4 py-1 rounded-full text-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 whitespace-nowrap">Kinder</button>
                        <button onclick="filterList('wc')"
                            class="filter-btn px-4 py-1 rounded-full text-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 whitespace-nowrap">WC</button>
                    </div>
                </div>
                <div id="stations-list" class="scroll-container p-4 space-y-3 flex-grow overflow-y-auto"></div>
            </div>

            <!-- VIEW: PROGRAMM -->
            <div id="view-events" class="view-section h-full w-full hidden bg-gray-50">
                <div class="scroll-container p-4 h-full overflow-y-auto">
                    <div
                        class="mb-6 p-5 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 text-white shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="ph ph-star-four text-6xl"></i>
                        </div>
                        <h2 class="font-bold text-lg mb-1 brand-font text-white">Aktuell & Demn√§chst</h2>
                        <div id="current-event-display" class="mt-2">
                            <p class="text-sm text-white/90">Lade Programm...</p>
                        </div>
                    </div>
                    <h3 class="text-gray-800 font-bold mb-4 px-1 border-b border-gray-200 pb-2">Programmablauf</h3>
                    <div id="timeline-container" class="space-y-0 relative border-l-2 border-gray-300 ml-3 pl-6 pb-24">
                    </div>
                </div>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="bottom-nav flex justify-around items-center text-center py-3 text-xs font-medium text-gray-500">
            <div onclick="switchTab('map')" id="nav-map"
                class="flex-1 cursor-pointer tab-active flex flex-col items-center"><i
                    class="ph ph-map-trifold text-2xl mb-1"></i><span>Karte</span></div>
            <div onclick="switchTab('list')" id="nav-list"
                class="flex-1 cursor-pointer tab-inactive flex flex-col items-center"><i
                    class="ph ph-list-dashes text-2xl mb-1"></i><span>Stationen</span></div>
            <div onclick="switchTab('events')" id="nav-events"
                class="flex-1 cursor-pointer tab-inactive flex flex-col items-center"><i
                    class="ph ph-calendar-star text-2xl mb-1"></i><span>Programm</span></div>
        </nav>

        <!-- Login Modal -->
        <div id="login-modal"
            class="fixed inset-0 z-[2000] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
            <div class="bg-white rounded-xl p-6 w-80 shadow-2xl">
                <h2 class="text-xl font-bold mb-4 text-center">Admin Login</h2>
                <input type="password" id="admin-pass" placeholder="Passwort"
                    class="w-full p-3 border rounded-lg mb-4 text-center focus:ring-2 focus:ring-yellow-500 outline-none">
                <div class="flex gap-2">
                    <button onclick="toggleAdminLogin()"
                        class="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Abbruch</button>
                    <button onclick="performLogin()"
                        class="flex-1 py-2 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600">Login</button>
                </div>
            </div>
        </div>

        <!-- Station Detail/Edit Modal -->
        <div id="detail-modal"
            class="fixed inset-0 z-[1000] hidden flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto" onclick="closeModal()"></div>
            <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-0 relative z-10 transform transition-transform duration-300 translate-y-full pointer-events-auto shadow-2xl max-h-[90vh] overflow-y-auto"
                id="modal-content">

                <!-- Image Display Header -->
                <div id="modal-image-container" class="w-full aspect-square bg-gray-200 relative hidden">
                    <img id="modal-image" src="" class="w-full h-full object-cover rounded-t-2xl">
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent h-20">
                    </div>
                </div>
                <div id="modal-drag-handle" class="w-12 h-1 bg-gray-300 rounded-full mx-auto mt-4 mb-2"></div>

                <div class="p-6 pt-0">
                    <!-- View Mode -->
                    <div id="modal-view-mode">
                        <div class="flex justify-between items-start mb-2 relative z-10">
                            <span id="modal-number"
                                class="bg-yellow-500 text-white font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm shadow-md">1</span>
                            <div>
                                <button onclick="editStation()"
                                    class="admin-badge bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold mr-2 hover:bg-blue-200"><i
                                        class="ph ph-pencil-simple"></i> Bearbeiten</button>
                                <button onclick="closeModal()"
                                    class="text-gray-400 hover:text-gray-800 bg-gray-100 rounded-full p-1"><i
                                        class="ph ph-x text-xl"></i></button>
                            </div>
                        </div>
                        <h2 id="modal-title" class="text-xl font-bold text-gray-900 mb-1 brand-font">Titel</h2>
                        <p id="modal-subtitle" class="text-yellow-600 text-xs font-bold tracking-wide uppercase mb-4">
                            Untertitel</p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-100">
                            <p id="modal-desc" class="text-gray-700 text-sm leading-relaxed">Beschreibung...</p>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button id="btn-internal-route"
                                class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 active:bg-yellow-600 shadow-md"><i
                                    class="ph ph-path text-lg"></i> Route</button>
                            <button id="btn-route"
                                class="flex-1 bg-gray-900 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 active:bg-gray-700 shadow-lg"><i
                                    class="ph ph-google-logo text-lg"></i> Maps</button>
                        </div>
                    </div>

                    <!-- Edit Mode -->
                    <div id="modal-edit-mode" class="hidden">
                        <h3 class="font-bold mb-3 text-lg">Station bearbeiten</h3>
                        <input id="edit-name" class="w-full mb-2 p-2 border rounded" placeholder="Name">
                        <textarea id="edit-desc" class="w-full mb-2 p-2 border rounded" rows="3"
                            placeholder="Beschreibung"></textarea>

                        <label class="text-xs font-bold text-gray-500 uppercase mt-2 block">Bild</label>
                        <div class="flex gap-2 mb-2">
                            <input type="file" id="image-upload" accept="image/*" class="hidden"
                                onchange="handleImageUpload(this)">
                            <button onclick="document.getElementById('image-upload').click()"
                                class="bg-gray-100 text-gray-700 px-3 py-2 rounded text-xs font-bold border border-gray-300 hover:bg-gray-200 w-full">
                                <i class="ph ph-camera text-lg align-middle mr-1"></i> Foto hochladen / w√§hlen
                            </button>
                        </div>
                        <input id="edit-image" class="w-full mb-2 p-2 border rounded text-xs text-gray-400"
                            placeholder="Base64 String (wird automatisch gef√ºllt)" readonly>

                        <label class="text-xs font-bold text-gray-500 uppercase mt-2 block">Tags / Filter</label>
                        <input id="edit-tags" class="w-full mb-2 p-2 border rounded" placeholder="z.B. food, drink">
                        <div id="available-tags" class="flex flex-wrap gap-2 mb-2"></div>

                        <input id="edit-time" class="w-full mb-4 p-2 border rounded"
                            placeholder="Uhrzeit (z.B. 'ab 18:00')">
                        <div class="flex gap-2">
                            <button onclick="deleteStation()"
                                class="flex-1 bg-red-100 text-red-600 py-2 rounded hover:bg-red-200">L√∂schen</button>
                            <button onclick="saveStationChanges()"
                                class="flex-1 bg-green-500 text-white py-2 rounded font-bold hover:bg-green-600">Speichern</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Edit Modal -->
        <div id="event-modal"
            class="fixed inset-0 z-[1050] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
            <div class="bg-white rounded-xl p-6 w-96 shadow-2xl m-4">
                <h3 class="font-bold mb-3 text-lg">Programm bearbeiten</h3>
                <input id="evt-time" class="w-full mb-2 p-2 border rounded" placeholder="Uhrzeit (z.B. 17:00)">
                <input id="evt-title" class="w-full mb-2 p-2 border rounded" placeholder="Titel">
                <input id="evt-desc" class="w-full mb-2 p-2 border rounded" placeholder="Beschreibung">
                <input id="evt-loc" class="w-full mb-2 p-2 border rounded" placeholder="Ort Text (z.B. Kirche)">

                <div class="flex gap-2 mb-2">
                    <input id="evt-lat" class="w-1/2 p-2 border rounded text-xs" placeholder="Lat (49...)">
                    <input id="evt-lng" class="w-1/2 p-2 border rounded text-xs" placeholder="Lng (10...)">
                    <button onclick="fillEventCoords()" class="bg-gray-200 px-2 rounded"
                        title="Nimm Kartenmitte">üìç</button>
                </div>

                <label class="text-xs font-bold text-gray-500 uppercase mt-2 block">Farbe</label>
                <select id="evt-color" class="w-full mb-4 p-2 border rounded">
                    <option value="yellow">Gelb (Standard)</option>
                    <option value="red">Rot</option>
                    <option value="blue">Blau</option>
                    <option value="purple">Lila</option>
                    <option value="gray">Grau</option>
                </select>

                <div class="flex gap-2">
                    <button onclick="deleteEvent()" id="btn-delete-event"
                        class="flex-1 bg-red-100 text-red-600 py-2 rounded hover:bg-red-200 hidden">L√∂schen</button>
                    <button onclick="closeEventModal()"
                        class="flex-1 bg-gray-200 text-gray-800 py-2 rounded">Abbruch</button>
                    <button onclick="saveEventChanges()"
                        class="flex-1 bg-green-500 text-white py-2 rounded font-bold hover:bg-green-600">Speichern</button>
                </div>
            </div>
        </div>

    </div>

    <!-- ==========================================
       JAVASCRIPT LOGIC
       ========================================== -->

    <!-- Firebase Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="module">
        // --- VARIABLES ---
        let map, userMarker, userLocation, routingControl;
        let stations = [];
        let events = [];
        let markers = [];
        let isAdmin = false;
        let activeStationId = null;
        let activeEventId = null;
        let activeTab = "map"; // Default tab
        let useLocalStorage = false;
        let db, auth, appId;
        let initializeApp, getAuth, signInAnonymously, getFirestore, collection, doc, getDocs, setDoc, deleteDoc;

        // --- SEED DATA ---
        const seedStations = [
            // Example with image
            { id: 1, name: "Deutsches Pinsel- & B√ºrstenmuseum", desc: "Genussgalerie, Cocktails. Dinkelsb√ºhler Str. 23", lat: 49.15714, lng: 10.5484, tags: ["drink", "food", "culture"], image: "https://images.unsplash.com/photo-1513883049090-d0b7439799bf?q=80&w=1000&auto=format&fit=crop" },
            { id: 2, name: "MSC Bechhofen", desc: "Kartoffelchips, Gl√ºhwein.", lat: 49.15724, lng: 10.54899, tags: ["food", "drink"] },
            { id: 3, name: "Bauernsch√§nke", desc: "Wahrsagespiel. Schlo√üstr.", lat: 49.15706, lng: 10.54951, tags: ["drink", "culture"], time: "ab 18:00" },
            { id: 5, name: "Evang. Kirchengemeinde", desc: "Johanniskirche (Marktplatz).", lat: 49.15796, lng: 10.55103, tags: ["food", "drink"] },
            { id: 10, name: "La Piccola Romana", desc: "Eis-Stand am Marktplatz.", lat: 49.15799, lng: 10.54959, tags: ["food", "drink"] },
            { id: 11, name: "Kiga St. Martin", desc: "Ansbacher Str.", lat: 49.1579, lng: 10.54949, tags: ["food", "drink", "kids"] },
            { id: 12, name: "Der orange Beck", desc: "Ansbacher Str.", lat: 49.15797, lng: 10.54937, tags: ["food", "drink"] },
            { id: 13, name: "Kiga St. Johannis", desc: "Ansbacher Str.", lat: 49.15811, lng: 10.54935, tags: ["food", "drink", "kids"] },
            { id: 14, name: "Der Blumenladen", desc: "Ansbacher Str.", lat: 49.15843, lng: 10.54871, tags: ["drink", "shop"] },
            { id: 15, name: "RV Adler", desc: "Ansbacher Str.", lat: 49.15852, lng: 10.5488, tags: ["food"] },
            { id: 16, name: "M√∂rlacher Wildkammer", desc: "Ansbacher Str.", lat: 49.15859, lng: 10.54974, tags: ["food"] },
            { id: 17, name: "Wildobsthof Mitsch", desc: "Ansbacher Str.", lat: 49.15863, lng: 10.54985, tags: ["food", "drink"] },
            { id: 18, name: "La Vida Local", desc: "Ansbacher Str.", lat: 49.15876, lng: 10.55016, tags: ["food"] },
            { id: 19, name: "Metzgerei Weinmann", desc: "Bratwurst, Leberk√§se. Am Kreisverkehr.", lat: 49.15866, lng: 10.55037, tags: ["food", "wc"] },
            { id: 20, name: "Imkerverein", desc: "Ansbacher Str.", lat: 49.15871, lng: 10.55064, tags: ["drink", "shop"] },
            { id: 21, name: "Pattra Thaimassage", desc: "Ansbacher Str.", lat: 49.15822, lng: 10.55167, tags: ["food"] },
            { id: 22, name: "Henkel Transporte", desc: "Gunzenhausener Str. 24", lat: 49.15811, lng: 10.55332, tags: ["food", "drink"] },
            { id: 23, name: "G√§rtnerei H√∂hn", desc: "Friedhofstr. 6", lat: 49.15887, lng: 10.5536, tags: ["shop"] },
            { id: 24, name: "Die Pinselfabrik", desc: "Big Band. N√§he Friedhof.", lat: 49.16019, lng: 10.55299, tags: ["culture", "event"], time: "18:00" },
            { id: 30, name: "EDEKA D√§ubler Stand", desc: "Ansbacher Str. / Inset", lat: 49.16093, lng: 10.55393, tags: ["food", "drink"] },
            { id: 28, name: "Sch√ºtzenhaus", desc: "Griechisch. Ziegeleistr. 9", lat: 49.15934, lng: 10.55054, tags: ["food"] },
            { id: 29, name: "Accentra Outlet", desc: "Pestalozzistr. 11", lat: 49.16266, lng: 10.55194, tags: ["drink", "shop"] },
            { id: 6, name: "Grund- & Mittelschule", desc: "Pestalozzistr. 12", lat: 49.15784, lng: 10.55056, tags: ["food", "kids"] },
            { id: 8, name: "Pferdehof Hiemeyer", desc: "Pestalozzistr.", lat: 49.15791, lng: 10.54995, tags: ["kids", "drink", "food"] },
            { id: 34, name: "TSV 1898 Bechhofen", desc: "Sportheim. Party.", lat: 49.16455, lng: 10.56021, tags: ["party", "drink"], time: "ab 21:00" },
            { id: 31, name: "Fritz KUNDNER GmbH", desc: "Eisenbahnstr. 5A.", lat: 49.15833, lng: 10.54919, tags: ["shop", "food"] },
            { id: 32, name: "Regens Wagner", desc: "Freiherr-von-Drais-Str.", lat: 49.16213, lng: 10.55679, tags: ["food", "drink", "kids", "wc"] },
            { id: 33, name: "Behindertenarbeit e.V.", desc: "Freiherr-von-Drais-Str.", lat: 49.16465, lng: 10.55995, tags: ["food"] },
            { id: 25, name: "Slawa Markt", desc: "Schaschlik. Liebersdorfer Str.", lat: 49.15981, lng: 10.55253, tags: ["food", "drink"] },
            { id: 26, name: "Tanzschule SK-Danceworld", desc: "Innenhof. Party.", lat: 49.15913, lng: 10.55123, tags: ["food", "drink", "wc", "party"], time: "ab 20:00" },
            { id: 27, name: "La Piccola Romana (Str.)", desc: "Pizza. Seitenstr.", lat: 49.15906, lng: 10.55076, tags: ["food", "wc"] },
            { id: 7, name: "Lumis Hundesalon", desc: "Hot Dog.", lat: 49.15786, lng: 10.55016, tags: ["food", "drink"] },
            { id: 9, name: "R√§ucherNest", desc: "Pulledpork.", lat: 49.15794, lng: 10.54976, tags: ["food"] },
            { id: 4, name: "Rockabilly Ranch Saloon", desc: "Bar.", lat: 49.15712, lng: 10.55191, tags: ["food", "drink", "kids"] }
        ];

        const seedEvents = [
            { id: "e1", time: "17:00", title: "Er√∂ffnung", desc: "Johanniskirche", loc: "Kirche", color: "yellow", lat: 49.15796, lng: 10.55103 },
            { id: "e2", time: "18:00", title: "Big Band", desc: "Pinselfabrik", loc: "Pinselfabrik", color: "gray", lat: 49.16019, lng: 10.55299 },
            { id: "e3", time: "19:30", title: "Tanzgruppe", desc: "Amaya Luna", loc: "Pinselfabrik", color: "gray", lat: 49.16019, lng: 10.55299 },
            { id: "e4", time: "20:00", title: "Feuershow", desc: "Kirchplatz", loc: "Kirche", color: "purple", lat: 49.15796, lng: 10.55103 },
            { id: "e5", time: "21:00", title: "Party", desc: "TSV Sportheim", loc: "Sportheim", color: "red", lat: 49.16455, lng: 10.56021 }
        ];

        // --- INITIALIZATION ---
        window.onload = async () => {
            // 0. Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('./sw.js');
                    console.log('SW registered');
                } catch (e) { console.log('SW fail', e); }
            }

            initMap();
            updateCurrentEvent();
            setInterval(updateCurrentEvent, 30000); // Check every 30s

            const btn = document.getElementById('status-indicator');

            if (typeof __firebase_config !== 'undefined') {
                try {
                    // Dynamic Import
                    const fbApp = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                    const fbAuth = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                    const fbStore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                    initializeApp = fbApp.initializeApp;
                    getAuth = fbAuth.getAuth;
                    signInAnonymously = fbAuth.signInAnonymously;
                    getFirestore = fbStore.getFirestore;
                    collection = fbStore.collection;
                    doc = fbStore.doc;
                    getDocs = fbStore.getDocs;
                    setDoc = fbStore.setDoc;
                    deleteDoc = fbStore.deleteDoc;

                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    await signInAnonymously(auth);
                    btn.innerText = "Online";
                    btn.classList.replace('text-gray-500', 'text-green-500');
                    showToast('Online-Modus aktiviert', 'success');
                    await loadData();
                } catch (e) {
                    console.error("Auth Error", e);
                    enableOfflineMode(btn);
                }
            } else {
                enableOfflineMode(btn);
            }
        };

        function enableOfflineMode(btn) {
            useLocalStorage = true;
            btn.innerText = "Lokal";
            btn.title = "Daten werden nur im Browser gespeichert";
            showToast('Lokal-Modus (kein Server)', 'info');
            loadData();
        }

        async function loadData() {
            if (useLocalStorage) {
                const sData = localStorage.getItem('stations_data');
                stations = sData ? JSON.parse(sData) : seedStations;
                const eData = localStorage.getItem('events_data');
                events = eData ? JSON.parse(eData) : seedEvents;
            } else {
                const sCol = collection(db, 'artifacts', appId, 'public', 'data', 'stations');
                const sSnap = await getDocs(sCol);
                stations = sSnap.empty ? seedStations : [];
                sSnap.forEach(doc => stations.push(doc.data()));

                const eCol = collection(db, 'artifacts', appId, 'public', 'data', 'events');
                const eSnap = await getDocs(eCol);
                events = eSnap.empty ? seedEvents : [];
                eSnap.forEach(doc => events.push(doc.data()));
            }
            refreshMapMarkers();
            renderList(stations);
            renderTimeline();
        }

        // --- TOAST SYSTEM ---
        window.showToast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'warning-circle' : 'info');
            toast.innerHTML = `<i class="ph ph-${icon} text-xl"></i><span>${msg}</span>`;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // --- MAP LOGIC ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([49.158, 10.552], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }).addTo(map);
        }

        function refreshMapMarkers() {
            markers.forEach(m => map.removeLayer(m.marker));
            markers = [];
            stations.forEach(s => {
                const icon = L.divIcon({ className: 'custom-pin', html: `<div style="background-color: #f59e0b; color: #000; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-family: sans-serif;">${s.id}</div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
                const marker = L.marker([s.lat, s.lng], { icon: icon, draggable: isAdmin }).addTo(map);
                marker.on('dragend', async (e) => {
                    if (!isAdmin) return;
                    const p = e.target.getLatLng();
                    s.lat = Number(p.lat.toFixed(5)); s.lng = Number(p.lng.toFixed(5));
                    await saveData('station', s);
                    showToast('Position aktualisiert', 'success');
                });
                marker.on('click', () => openModal(s));
                markers.push({ id: s.id, marker: marker });
            });
        }

        // --- DATA PERSISTENCE ---
        async function saveData(type, item) {
            if (useLocalStorage) {
                if (type === 'station') localStorage.setItem('stations_data', JSON.stringify(stations));
                if (type === 'event') localStorage.setItem('events_data', JSON.stringify(events));
            } else {
                const colName = type === 'station' ? 'stations' : 'events';
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', colName);
                const data = JSON.parse(JSON.stringify(item));
                await setDoc(doc(colRef, item.id.toString()), data);
            }
        }

        async function deleteData(type, id) {
            if (useLocalStorage) {
                if (type === 'station') {
                    stations = stations.filter(x => x.id != id);
                    localStorage.setItem('stations_data', JSON.stringify(stations));
                }
                if (type === 'event') {
                    events = events.filter(x => x.id != id);
                    localStorage.setItem('events_data', JSON.stringify(events));
                }
            } else {
                const colName = type === 'station' ? 'stations' : 'events';
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', colName);
                await deleteDoc(doc(colRef, id.toString()));
            }
        }

        // --- ADMIN UI ---
        window.toggleAdminLogin = () => { if (isAdmin) return; document.getElementById('login-modal').classList.toggle('hidden'); };
        window.performLogin = () => {
            if (document.getElementById('admin-pass').value === "licht2025") {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('admin-bar').classList.remove('hidden');
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('lock-icon').classList.replace('ph-lock-key', 'ph-lock-key-open');
                document.getElementById('lock-icon').classList.add('text-green-500');
                refreshMapMarkers();
                renderTimeline();
                showToast('Als Admin angemeldet', 'success');
            } else showToast('Falsches Passwort', 'error');
        };
        window.logoutAdmin = () => {
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('admin-bar').classList.add('hidden');
            document.getElementById('lock-icon').classList.replace('ph-lock-key-open', 'ph-lock-key');
            document.getElementById('lock-icon').classList.remove('text-green-500');
            refreshMapMarkers();
            renderTimeline();
            showToast('Abgemeldet', 'info');
        };
        window.toggleAdminPanel = () => {
            const p = document.getElementById('admin-panel');
            if (p.classList.contains('hidden')) {
                p.classList.remove('hidden');
                const sStr = stations.map(s => `{ id: ${s.id}, name: "${s.name}", desc: "${s.desc}", lat: ${s.lat}, lng: ${s.lng}, tags: ${JSON.stringify(s.tags)}${s.time ? `, time: "${s.time}"` : ''}${s.image ? `, image: "${s.image}"` : ''} }`).join(",\n    ");
                const eStr = events.map(e => `{ id: "${e.id}", time: "${e.time}", title: "${e.title}", desc: "${e.desc}", loc: "${e.loc}", color: "${e.color}", lat: ${e.lat}, lng: ${e.lng} }`).join(",\n    ");
                document.getElementById('export-area').value = `const stations = [\n    ${sStr}\n];\n\nconst events = [\n    ${eStr}\n];`;
            } else p.classList.add('hidden');
        };
        window.handleAdminAdd = () => {
            if (activeTab === 'events') openEventModal();
            else addNewStation();
        }

        // --- UI ---
        window.openModal = (s) => {
            activeStationId = s.id;
            document.getElementById('modal-number').innerText = s.id;
            document.getElementById('modal-title').innerText = s.name;
            document.getElementById('modal-subtitle').innerText = s.tags.join(' ‚Ä¢ ').toUpperCase();

            let descHtml = s.desc;
            if (s.time) descHtml = `<strong class="text-yellow-700 block mb-1">‚è∞ ${s.time} Uhr</strong>` + descHtml;
            document.getElementById('modal-desc').innerHTML = descHtml;

            // Image Logic
            const imgCont = document.getElementById('modal-image-container');
            const imgEl = document.getElementById('modal-image');
            if (s.image) {
                imgEl.src = s.image;
                imgCont.classList.remove('hidden');
            } else {
                imgCont.classList.add('hidden');
            }

            document.getElementById('modal-view-mode').classList.remove('hidden');
            document.getElementById('modal-edit-mode').classList.add('hidden');

            document.getElementById('btn-route').onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}`, '_blank');
            document.getElementById('btn-internal-route').onclick = () => { window.switchTab('map'); window.closeModal(); if (!userLocation) window.locateUser(() => window.calculateRoute(s.lat, s.lng)); else window.calculateRoute(s.lat, s.lng); };
            document.getElementById('detail-modal').classList.remove('hidden');
            requestAnimationFrame(() => document.getElementById('modal-content').classList.remove('translate-y-full'));
        };

        window.editStation = () => {
            const s = stations.find(x => x.id == activeStationId);
            if (!s) return;
            document.getElementById('modal-view-mode').classList.add('hidden');
            document.getElementById('modal-edit-mode').classList.remove('hidden');
            document.getElementById('edit-name').value = s.name;
            document.getElementById('edit-desc').value = s.desc;
            document.getElementById('edit-tags').value = s.tags.join(', ');
            document.getElementById('edit-time').value = s.time || '';
            document.getElementById('edit-image').value = s.image || '';
            renderTagHelper(s.tags);
        };

        window.saveStationChanges = async () => {
            const s = stations.find(x => x.id == activeStationId);
            if (!s) return;
            s.name = document.getElementById('edit-name').value;
            s.desc = document.getElementById('edit-desc').value;
            s.tags = document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t);
            s.time = document.getElementById('edit-time').value || null;
            s.image = document.getElementById('edit-image').value || null;

            await saveData('station', s);
            showToast('Station gespeichert', 'success');
            renderList(stations);
            openModal(s);
        };

        window.addNewStation = async () => {
            const newId = Math.max(...stations.map(s => s.id), 0) + 1;
            const c = map.getCenter();
            const ns = { id: newId, name: "Neue Station", desc: "...", lat: Number(c.lat.toFixed(5)), lng: Number(c.lng.toFixed(5)), tags: ["food"] };
            stations.push(ns);
            await saveData('station', ns);
            refreshMapMarkers();
            renderList(stations);
            openModal(ns);
            editStation();
            showToast('Station erstellt', 'success');
        };

        window.deleteStation = async () => {
            if (!confirm("L√∂schen?")) return;
            await deleteData('station', activeStationId);
            stations = stations.filter(x => x.id != activeStationId);
            refreshMapMarkers();
            renderList(stations);
            closeModal();
            showToast('Station gel√∂scht', 'info');
        };

        // Tags Helper
        function renderTagHelper(currentTags) {
            const container = document.getElementById('available-tags');
            container.innerHTML = '';
            const allTags = new Set();
            stations.forEach(s => s.tags.forEach(t => allTags.add(t)));
            if (allTags.size === 0) ['food', 'drink', 'wc', 'kids'].forEach(t => allTags.add(t));
            allTags.forEach(tag => {
                const btn = document.createElement('span');
                btn.className = `tag-badge px-2 py-1 rounded border text-xs font-bold ${currentTags.includes(tag) ? 'selected' : 'bg-gray-100 text-gray-600 border-gray-300'}`;
                btn.innerText = tag;
                btn.onclick = () => toggleTag(tag);
                container.appendChild(btn);
            });
        }
        window.toggleTag = (tag) => {
            const input = document.getElementById('edit-tags');
            let current = input.value.split(',').map(t => t.trim()).filter(t => t);
            if (current.includes(tag)) current = current.filter(t => t !== tag);
            else current.push(tag);
            input.value = current.join(', ');
            renderTagHelper(current);
        };

        // Standard functions (Lists, Filters, Events)
        // ... (Identical logical structure as previous, kept concise for brevity)
        window.closeModal = () => { document.getElementById('modal-content').classList.add('translate-y-full'); setTimeout(() => document.getElementById('detail-modal').classList.add('hidden'), 300); };
        window.switchTab = (tabName) => {
            activeTab = tabName;
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.bottom-nav > div').forEach(el => { el.classList.remove('tab-active'); el.classList.add('tab-inactive'); el.classList.replace('text-yellow-600', 'text-gray-500'); });
            document.getElementById(`nav-${tabName}`).classList.remove('tab-inactive'); document.getElementById(`nav-${tabName}`).classList.add('tab-active');
            if (tabName === 'map' && map) setTimeout(() => map.invalidateSize(), 200);
        };
        window.filterList = (category) => {
            document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-yellow-600', 'text-white', 'shadow-sm'); b.classList.add('bg-white', 'text-gray-700', 'border'); });
            event.target.classList.remove('bg-white', 'text-gray-700', 'border'); event.target.classList.add('bg-yellow-600', 'text-white', 'shadow-sm');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = stations.filter(s => { const matchesCat = category === 'all' || s.tags.includes(category); const matchesSearch = s.name.toLowerCase().includes(search) || s.desc.toLowerCase().includes(search); return matchesCat && matchesSearch; });
            renderList(filtered);
        };
        window.renderList = (items) => {
            const list = document.getElementById('stations-list');
            list.innerHTML = '';
            if (items.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 mt-10">Keine Ergebnisse.</div>'; return; }
            items.forEach(s => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex gap-4 items-center active:bg-gray-50 transition-colors cursor-pointer relative overflow-hidden';
                el.onclick = () => openModal(s);

                // Image Thumbnail
                let imgHtml = '';
                if (s.image) {
                    imgHtml = `<div class="w-12 h-12 rounded-lg bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-300 mr-3"><img src="${s.image}" class="w-full h-full object-cover"></div>`;
                }

                let iconHtml = '';
                if (s.tags.includes('wc')) iconHtml += '<i class="ph ph-toilet text-blue-500 ml-2 text-lg"></i>';
                if (s.tags.includes('kids')) iconHtml += '<i class="ph ph-baby text-pink-500 ml-2 text-lg"></i>';

                el.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center font-bold text-white shadow-md border border-yellow-400 mr-3">${s.id}</div>
                    ${imgHtml}
                    <div class="flex-grow min-w-0">
                        <div class="flex flex-wrap items-center mb-1"><h3 class="font-bold text-gray-900 text-sm mr-1 truncate">${s.name}</h3>${iconHtml}</div>
                        <p class="text-xs text-gray-500 line-clamp-2">${s.desc}</p>
                    </div>
                    <i class="ph ph-caret-right text-gray-300"></i>
                `;
                list.appendChild(el);
            });
        };
        document.getElementById('search-input').addEventListener('input', () => document.querySelector('.filter-btn.bg-yellow-600').click());

        // --- IMAGE HANDLING ---
        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                setLoading(true, "Verarbeite Bild...");
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('edit-image').value = dataUrl;
                        showToast('Bild verarbeitet', 'success');
                        setLoading(false);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- UX HELPERS ---
        function setLoading(active, text = "Lade...") {
            const el = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            if (active) {
                txt.innerText = text;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // Geolocation
        // Geolocation
        window.locateUser = (cb) => {
            if (!navigator.geolocation) { showToast("Kein GPS verf√ºgbar", 'error'); return; }
            setLoading(true, "Suche GPS...");
            document.getElementById('status-indicator').innerText = "Suche...";
            navigator.geolocation.getCurrentPosition(pos => {
                setLoading(false);
                const lat = pos.coords.latitude; const lng = pos.coords.longitude; userLocation = { lat, lng };
                if (userMarker) userMarker.setLatLng([lat, lng]);
                else { const icon = L.divIcon({ html: '<div style="width:18px;height:18px;background:#2563eb;border-radius:50%;border:3px solid white;box-shadow:0 0 10px #2563eb"></div>', className: 'user-loc', iconSize: [18, 18] }); userMarker = L.marker([lat, lng], { icon: icon }).addTo(map); }
                if (!routingControl) map.setView([lat, lng], 18);
                document.getElementById('status-indicator').innerText = "Verbunden"; if (cb) cb();
                showToast("Standort gefunden", 'success');
            }, err => {
                setLoading(false);
                showToast("GPS Fehler", 'error');
                document.getElementById('status-indicator').innerText = "GPS Fehler";
            });
        };
        window.resetMap = () => { map.setView([49.158, 10.552], 16); window.clearRoute(); };
        window.calculateRoute = (dLat, dLng) => {
            if (!userLocation) return;
            setLoading(true, "Berechne Route...");
            window.clearRoute();
            document.getElementById('route-info').classList.remove('hidden');
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLocation.lat, userLocation.lng), L.latLng(dLat, dLng)],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{ color: '#3b82f6', opacity: 0.8, weight: 6 }] },
                show: false, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true
            }).addTo(map);

            // Routing Machine hat kein einfaches "loaded" event, wir faken es kurz
            setTimeout(() => setLoading(false), 1000);
        };
        window.clearRoute = () => { if (routingControl) { map.removeControl(routingControl); routingControl = null; } document.getElementById('route-info').classList.add('hidden'); };
        window.startInternalNav = (lat, lng) => { window.switchTab('map'); window.closeModal(); if (!userLocation) window.locateUser(() => window.calculateRoute(lat, lng)); else window.calculateRoute(lat, lng); };

        // Events CRUD (kept brief)
        window.openEventModal = (evtId) => {
            document.getElementById('event-modal').classList.remove('hidden');
            if (evtId) {
                activeEventId = evtId;
                const e = events.find(x => x.id == evtId);
                document.getElementById('evt-time').value = e.time; document.getElementById('evt-title').value = e.title;
                document.getElementById('evt-desc').value = e.desc; document.getElementById('evt-loc').value = e.loc;
                document.getElementById('evt-color').value = e.color; document.getElementById('evt-lat').value = e.lat; document.getElementById('evt-lng').value = e.lng;
                document.getElementById('btn-delete-event').classList.remove('hidden');
            } else {
                activeEventId = null; document.getElementById('evt-time').value = ""; document.getElementById('evt-title').value = ""; document.getElementById('evt-desc').value = "";
                document.getElementById('evt-loc').value = ""; document.getElementById('evt-color').value = "yellow"; document.getElementById('evt-lat').value = ""; document.getElementById('evt-lng').value = "";
                document.getElementById('btn-delete-event').classList.add('hidden');
            }
        };
        window.closeEventModal = () => document.getElementById('event-modal').classList.add('hidden');
        window.fillEventCoords = () => { const c = map.getCenter(); document.getElementById('evt-lat').value = c.lat.toFixed(5); document.getElementById('evt-lng').value = c.lng.toFixed(5); };
        window.saveEventChanges = async () => {
            const newData = { id: activeEventId || "e" + Date.now(), time: document.getElementById('evt-time').value, title: document.getElementById('evt-title').value, desc: document.getElementById('evt-desc').value, loc: document.getElementById('evt-loc').value, color: document.getElementById('evt-color').value, lat: Number(document.getElementById('evt-lat').value) || 49.158, lng: Number(document.getElementById('evt-lng').value) || 10.552 };
            if (activeEventId) { const idx = events.findIndex(x => x.id == activeEventId); if (idx >= 0) events[idx] = newData; } else events.push(newData);
            events.sort((a, b) => a.time.localeCompare(b.time));
            await saveData('event', newData); renderTimeline(); closeEventModal(); showToast('Event gespeichert', 'success');
        };
        window.deleteEvent = async () => { if (!confirm("L√∂schen?")) return; await deleteData('event', activeEventId); events = events.filter(x => x.id != activeEventId); renderTimeline(); closeEventModal(); showToast('Event gel√∂scht', 'info'); };
        window.renderTimeline = () => {
            const container = document.getElementById('timeline-container');
            container.innerHTML = events.map(e => `
                <div class="mb-8 relative group">
                    <div class="absolute -left-[31px] bg-gray-50 border-2 border-${e.color}-500 w-4 h-4 rounded-full"></div>
                    <div class="flex justify-between items-start">
                        <div><span class="text-${e.color}-600 font-bold text-sm">${e.time} Uhr</span><h4 class="text-gray-900 font-bold text-lg">${e.title}</h4><p class="text-gray-600 text-sm mt-1">${e.desc}</p><div class="mt-2 inline-block bg-white border border-gray-200 px-2 py-1 rounded text-xs text-gray-500 shadow-sm"><i class="ph ph-map-pin mr-1"></i>${e.loc}</div></div>
                        <div class="flex flex-col gap-2"><button onclick="window.startInternalNav(${e.lat}, ${e.lng})" class="bg-${e.color}-100 hover:bg-${e.color}-200 text-${e.color}-700 p-2 rounded-lg shadow-sm border border-${e.color}-200 transition-colors"><i class="ph ph-arrow-bend-up-right text-xl"></i></button>${isAdmin ? `<button onclick="window.openEventModal('${e.id}')" class="bg-gray-800 text-white p-2 rounded-lg shadow-sm"><i class="ph ph-pencil-simple text-xl"></i></button>` : ''}</div>
                    </div>
                </div>`).join('');
        };
        function updateCurrentEvent() {
            const now = new Date();
            // Fake Datum f√ºr Demo wenn wir nicht am 22.11. sind
            // const now = new Date("2025-11-22T18:30:00"); 

            const currentH = now.getHours();
            const currentM = now.getMinutes();
            const timeVal = currentH * 60 + currentM;

            // Finde aktuelles Event
            let active = null;
            let next = null;

            // Sort events by time
            const sorted = [...events].sort((a, b) => {
                const [h1, m1] = a.time.split(':').map(Number);
                const [h2, m2] = b.time.split(':').map(Number);
                return (h1 * 60 + m1) - (h2 * 60 + m2);
            });

            for (let i = 0; i < sorted.length; i++) {
                const e = sorted[i];
                const [h, m] = e.time.split(':').map(Number);
                const eTime = h * 60 + m;

                if (timeVal >= eTime) {
                    active = e;
                } else {
                    if (!next) next = e;
                }
            }

            let html = '';
            if (active) {
                html += `<span class="inline-block bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded mb-1 animate-pulse">JETZT</span>
                         <p class="font-bold leading-tight text-white text-sm">${active.title}</p>
                         <p class="text-xs text-white/80">${active.loc}</p>`;
            }

            if (next) {
                html += `<div class="mt-2 pt-2 border-t border-white/20">
                         <span class="inline-block bg-white/20 text-white text-[10px] font-bold px-1 rounded mb-0.5">BALD (${next.time})</span>
                         <p class="font-medium leading-tight text-white text-xs">${next.title}</p>
                         </div>`;
            }

            if (!active && !next) {
                html = `<p class="text-sm text-white/90">Keine Events mehr heute.</p>`;
            }

            document.getElementById('current-event-display').innerHTML = html;
        }
    </script>
</body>

</html>